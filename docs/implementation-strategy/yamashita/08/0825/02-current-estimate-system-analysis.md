# 現在の見積もりシステム分析

## 現在のシステム構成

### 1. アーキテクチャ概要

#### 主要コンポーネント

- **BlueprintDetailLayout**: 図面詳細ページの全体レイアウト
- **BlueprintEstimateContainer**: 見積もり作業の中心コンポーネント
- **ResizableLayout**: 図面ビューアと見積もりパネルの分割表示

#### レイアウト構造

```
BlueprintDetailLayout
├── Header (タブナビゲーション + 戻るボタン)
├── ResizableLayout
│   ├── BlueprintViewer (左側: 図面表示)
│   └── BlueprintEstimateContainer (右側: 見積もり作業)
```

### 2. 見積もり機能詳細

#### 基本的なワークフロー

1. **材料選択**
   - マスターデータから材料を選択
   - 図面寸法データ(length, width, height, weight)を使用した自動計算
   - 掛け率による価格調整(デフォルト100%)

2. **工程選択**
   - 複数工程の追加・削除が可能
   - 各工程に作業時間(分)を入力
   - 工程別の価格計算(時間ベース)
   - 掛け率による価格調整

3. **その他費用**
   - 自由項目の追加・削除
   - 項目名と価格の直接入力

4. **見積もり結果**
   - 材料費、工程費、その他費用の自動合計
   - 手動編集機能(計算結果を手動で上書き可能)
   - 見積もり確定機能

#### 技術的特徴

- **動的計算**: 数式評価によるリアルタイム価格計算
- **状態管理**: 複雑な見積もりデータの一元管理
- **手動編集**: 自動計算と手動調整のハイブリッド
- **バリデーション**: 変更検知による保存制御

### 3. データ構造分析

#### MaterialSelection（材料選択）

```typescript
interface MaterialSelection {
  id: string;
  materialName: string;
  formula: string; // 計算式（寸法データ使用）
  price: number; // 計算結果
}
```

#### ProcessSelection（工程選択）

```typescript
interface ProcessSelection {
  id: string;
  processName: string;
  formula: string; // 基本計算式
  time: number; // 作業時間(分)
  price: number; // 時間×単価の計算結果
}
```

#### 計算システム

- **寸法データ**: `DIMENSIONS = { length, width, height, weight }`
- **計算式**: 文字列として保存し、Function()で実行
- **掛け率**: 材料・工程それぞれに独立した掛け率設定

### 4. UX/UI分析（スクリーンショット参照）

#### レイアウト特徴

- **左右分割**: 図面ビューア(約67%) + 見積もりパネル(約33%)
- **図面ビューア**: 複数ビュー表示、サイドバーでの管理
- **見積もりパネル**: 縦スクロール可能な作業エリア

#### 見積もりパネルUI構成

1. **材料選択セクション**
   - 選択済み材料の表示 or 選択ドロップダウン
   - 掛け率入力フィールド
   - 削除ボタン

2. **工程選択セクション**
   - 追加済み工程のリスト表示
   - 各工程の時間入力フィールド
   - 工程追加ドロップダウン
   - 掛け率入力フィールド

3. **その他費用セクション**
   - カスタム項目の追加・編集
   - 項目名と価格の入力

4. **見積もり結果セクション**
   - 各カテゴリ別の金額表示
   - 手動編集ボタン
   - 合計金額の強調表示

5. **保存ボタン**
   - 下部固定配置
   - 変更検知による活性/非活性制御

### 5. 強みと課題

#### 現システムの強み

- **直感的UI**: 材料→工程→その他の論理的フロー
- **柔軟な計算**: 数式ベースの動的価格計算
- **手動調整**: 自動計算の上書き機能
- **リアルタイム更新**: 即座の価格反映

#### 確認された課題

- **ページ遷移の煩雑さ**: 複数図面処理時の効率性低下
- **作業の分断**: 図面ごとに独立した見積もり作業
- **全体把握の困難**: 案件全体の見積もり進捗が不明確

### 6. 新システムへの移行要件

#### 保持すべき機能

- 材料・工程・その他費用の3段階構成
- 数式ベースの動的計算システム
- 掛け率による価格調整機能
- 手動編集機能
- リアルタイム計算表示

#### 改善すべき点

- Dialog化による作業効率向上
- 複数図面の一括管理
- 見積もり進捗の可視化
- 案件全体での見積もり統合

この分析を基に、現在の高品質な見積もり機能を維持しつつ、Dialog方式による効率的なワークフローを実現する。
